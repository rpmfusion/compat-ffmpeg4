From 73a196755939f29515872a361c9f17728afbf3bb Mon Sep 17 00:00:00 2001
From: Leo Izen <leo.izen@gmail.com>
Date: Fri, 6 Jun 2025 16:09:34 -0400
Subject: [PATCH] configure: rename POSIX ioctl check

Commit 00b64fca55a3a009c9d0e391c85f4fd3291e5d12 introduced configure
detection for HAVE_POSIX_IOCTL but unfortunately this conflicts with
v4l-utils version 1.30, which itself checks for #ifdef HAVE_POSIX_IOCTL
in a public header and erroneously determines it to be true because we
define this to be 0.

Since this is only used for avdevice/v4l2, we rename this to something
else, namely ioctl_posix, simply to prevent the name conflict with the
file /usr/include/libv4l2.h at least until they can upstream a fix on
their end.

Signed-off-by: Leo Izen <leo.izen@gmail.com>
---
 configure          | 4 ++--
 libavdevice/v4l2.c | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/configure b/configure
index 7729f48d1829..6833eb9a8cca 100755
--- a/configure
+++ b/configure
@@ -2335,6 +2335,7 @@ HAVE_LIST="
     $TOOLCHAIN_FEATURES
     $TYPES_LIST
     gzip
+    ioctl_posix
     libdrm_getfb2
     makeinfo
     makeinfo_html
@@ -2346,7 +2347,6 @@ HAVE_LIST="
     opencl_vaapi_intel_media
     perl
     pod2man
-    posix_ioctl
     texi2html
     zlib_gzip
 "
@@ -6654,7 +6654,7 @@ rsync --help 2> /dev/null | grep -q 'contimeout=' && enable rsync_contimeout ||
 check_headers linux/fb.h
 check_headers linux/videodev2.h
 test_code cc linux/videodev2.h "struct v4l2_frmsizeenum vfse; vfse.discrete.width = 0;" && enable_sanitized struct_v4l2_frmivalenum_discrete
-test_code cc sys/ioctl.h "int ioctl(int, int, ...)" && enable posix_ioctl
+test_code cc sys/ioctl.h "int ioctl(int, int, ...)" && enable ioctl_posix
 
 # check V4L2 codecs available in the API
 if enabled v4l2_m2m; then
diff --git a/libavdevice/v4l2.c b/libavdevice/v4l2.c
index f90490eebfc8..9d6d4550e055 100644
--- a/libavdevice/v4l2.c
+++ b/libavdevice/v4l2.c
@@ -95,7 +95,7 @@ struct video_data {
     int (*open_f)(const char *file, int oflag, ...);
     int (*close_f)(int fd);
     int (*dup_f)(int fd);
-#if HAVE_POSIX_IOCTL
+#if HAVE_IOCTL_POSIX
     int (*ioctl_f)(int fd, int request, ...);
 #else
     int (*ioctl_f)(int fd, unsigned long int request, ...);
-- 
2.51.0

